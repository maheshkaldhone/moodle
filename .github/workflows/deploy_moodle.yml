name: Moodle Deployment

on:
  push:
    branches:
      - main

jobs:
  fetch-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Zip mod directory
        run: |
          # Zip the `mod` directory
          zip -r mod.zip ./mod
          # Set the zip file path as an environment variable
          echo "MOD_ZIP_PATH=$(pwd)/mod.zip" >> $GITHUB_ENV

      - name: Backup current mod directory
        run: |
          # Create a timestamp for the backup
          TIMESTAMP=$(date +'%Y%m%d%H%M%S')
          BACKUP_PATH="/tmp/mod_backup_$TIMESTAMP.zip"
          
          # Zip the current mod directory with the timestamp in the name
          sudo zip -r "$BACKUP_PATH" /var/www/html/moodle/mod
          echo "Backup created at $BACKUP_PATH"

      - name: Deploy new mod directory
        run: |
          # Extract the zip file into the Moodle directory
          sudo unzip -o ${{ env.MOD_ZIP_PATH }} -d /var/www/html/moodle/
          echo "Deployed the new mod directory"
